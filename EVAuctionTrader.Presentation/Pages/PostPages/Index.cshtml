@page
@using EVAuctionTrader.BusinessObject.Enums
@model EVAuctionTrader.Presentation.Pages.PostPages.IndexModel
@{
    ViewData["Title"] = "Browse Posts";
}

<div class="staff-page-clean">
    <div class="container">
        <!-- Header -->
        <div class="staff-header-clean">
            <h1 class="staff-title-clean">
                <i class="bi bi-grid-3x3-gap"></i>
                Browse All Posts
            </h1>
            <p class="staff-subtitle-clean">Discover vehicles and batteries from our community</p>
        </div>

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Filter Section -->
        <div class="staff-card-clean">
            <div class="staff-card-header-clean">
                <h3 class="staff-card-title-clean">
                    <i class="bi bi-funnel"></i>
                    Filters & Search
                </h3>
            </div>
            <div class="staff-card-body-clean">
                <form method="get" id="filterForm">
                    <!-- Search Bar -->
                    <div class="search-bar-clean mb-3">
                        <i class="bi bi-search search-icon-clean"></i>
                        <input type="text" name="search" class="search-input-clean"
                               placeholder="Search by title or location..."
                               value="@Model.Search">
                    </div>

                    <!-- ✅ MỚI: Quick Price Range Buttons -->
                    <div class="mb-3">
                        <label class="filter-label-clean mb-2">
                            <i class="bi bi-cash-stack"></i> Quick Price Filter
                        </label>
                        <div class="price-range-buttons">
                            @foreach (var range in Model.PriceRanges)
                            {
                                var isActive = (range.MinPrice == Model.MinPrice && range.MaxPrice == Model.MaxPrice);
                                <button type="button"
                                        class="price-range-btn @(isActive ? "active" : "")"
                                        onclick="selectPriceRange(@(range.MinPrice?.ToString() ?? "null"), @(range.MaxPrice?.ToString() ?? "null"))">
                                    @range.Label
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Hidden inputs for price range -->
                    <input type="hidden" name="minPrice" id="minPriceInput" value="@Model.MinPrice" />
                    <input type="hidden" name="maxPrice" id="maxPriceInput" value="@Model.MaxPrice" />

                    <!-- Filter Grid -->
                    <div class="filter-grid-clean">
                        <div class="filter-group-clean">
                            <label class="filter-label-clean">
                                <i class="bi bi-tag"></i> Post Type
                            </label>
                            <select name="postType" class="filter-input-clean">
                                <option value="">All Types</option>
                                <option value="@((int)PostType.Vehicle)" selected="@(Model.PostType == PostType.Vehicle)">Vehicle</option>
                                <option value="@((int)PostType.Battery)" selected="@(Model.PostType == PostType.Battery)">Battery</option>
                            </select>
                        </div>

                        <div class="filter-group-clean">
                            <label class="filter-label-clean">
                                <i class="bi bi-star"></i> Version
                            </label>
                            <select name="postVersion" class="filter-input-clean">
                                <option value="">All Versions</option>
                                <option value="@((int)PostVersion.Free)" selected="@(Model.PostVersion == PostVersion.Free)">Free</option>
                                <option value="@((int)PostVersion.Vip)" selected="@(Model.PostVersion == PostVersion.Vip)">VIP</option>
                            </select>
                        </div>

                        @if (User.IsInRole("Admin"))
                        {
                            <div class="filter-group-clean">
                                <label class="filter-label-clean">
                                    <i class="bi bi-circle-fill"></i> Status (Admin Only)
                                </label>
                                <select name="postStatus" class="filter-input-clean">
                                    <option value="">All Status</option>
                                    <option value="@((int)PostStatus.Active)" selected="@(Model.PostStatus == PostStatus.Active)">Active</option>
                                    <option value="@((int)PostStatus.Closed)" selected="@(Model.PostStatus == PostStatus.Closed)">Closed</option>
                                    <option value="@((int)PostStatus.Draft)" selected="@(Model.PostStatus == PostStatus.Draft)">Draft</option>
                                    <option value="@((int)PostStatus.Removed)" selected="@(Model.PostStatus == PostStatus.Removed)">Removed (Banned)</option>
                                </select>
                            </div>
                        }

                        <div class="filter-group-clean">
                            <label class="filter-label-clean">
                                <i class="bi bi-sort-numeric-down"></i> Sort by Price
                            </label>
                            <select name="priceSort" class="filter-input-clean">
                                <option value="true" selected="@Model.PriceSort">Low to High</option>
                                <option value="false" selected="@(!Model.PriceSort)">High to Low</option>
                            </select>
                        </div>
                    </div>

                    <!-- ✅ MỚI: Custom Price Range (Optional) -->
                    <div class="mt-3">
                        <label class="filter-label-clean mb-2">
                            <i class="bi bi-sliders"></i> Custom Price Range (Optional)
                        </label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <input type="number"
                                       class="filter-input-clean"
                                       placeholder="Min Price (VND)"
                                       id="customMinPrice"
                                       step="1000000" />
                            </div>
                            <div class="col-md-6">
                                <input type="number"
                                       class="filter-input-clean"
                                       placeholder="Max Price (VND)"
                                       id="customMaxPrice"
                                       step="1000000" />
                            </div>
                        </div>
                        <button type="button"
                                class="btn-clean btn-secondary-clean mt-2"
                                onclick="applyCustomPrice()">
                            <i class="bi bi-check-circle"></i> Apply Custom Price
                        </button>
                    </div>

                    <!-- Action Buttons -->
                    <div class="filter-actions-clean mt-3">
                        <button type="submit" class="btn-clean btn-primary-clean">
                            <i class="bi bi-search"></i> Apply Filters
                        </button>
                        <a asp-page="/PostPages/Index" class="btn-clean btn-secondary-clean">
                            <i class="bi bi-x-circle"></i> Clear All
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Posts Grid -->
        @if (Model.Posts != null && Model.Posts.Any())
        {
            <div class="row g-4 mt-3">
                @foreach (var post in Model.Posts)
                {
                    <div class="col-md-6 col-lg-4">
                        <div class="post-card-modern @(post.Status == PostStatus.Removed ? "banned-post" : "")">
                            <!-- Post Image -->
                            <div class="post-image-container">
                                @if (post.PhotoUrls != null && post.PhotoUrls.Any())
                                {
                                    <img src="@post.PhotoUrls.First()" alt="@post.Title" class="post-image">
                                }
                                else
                                {
                                    <div class="post-image-placeholder">
                                        <i class="bi bi-image"></i>
                                    </div>
                                }

                                <!-- Version Badge -->
                                <span class="version-badge @(post.Version == PostVersion.Vip ? "badge-vip" : "badge-free")">
                                    @if (post.Version == PostVersion.Vip)
                                    {
                                        <i class="bi bi-star-fill"></i>
                                        <text> VIP</text>
                                    }
                                    else
                                    {
                                        <i class="bi bi-tag"></i>
                                        <text> FREE</text>
                                    }
                                </span>

                                <!-- Status Badge -->
                                <span class="status-badge badge-@post.Status.ToString().ToLower()">
                                    @if (post.Status == PostStatus.Removed)
                                    {
                                        <i class="bi bi-slash-circle"></i>
                                        <text> BANNED</text>
                                    }
                                    else if (post.Status == PostStatus.Active)
                                    {
                                        <i class="bi bi-check-circle"></i>
                                        <text> ACTIVE</text>
                                    }
                                    else if (post.Status == PostStatus.Draft)
                                    {
                                        <i class="bi bi-pencil"></i>
                                        <text> DRAFT</text>
                                    }
                                    else if (post.Status == PostStatus.Closed)
                                    {
                                        <i class="bi bi-x-circle"></i>
                                        <text> CLOSED</text>
                                    }
                                    else
                                    {
                                        @post.Status
                                    }
                                </span>
                            </div>

                            @if (post.Status == PostStatus.Removed)
                            {
                                @if (User.IsInRole("Admin"))
                                {
                                    <div class="ban-warning-compact admin-view">
                                        <i class="bi bi-shield-exclamation"></i>
                                        <span>This post was banned and is hidden from public view</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="ban-warning-compact">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        <span>Post Removed by Admin</span>
                                    </div>
                                }
                            }

                            <!-- Post Content -->
                            <div class="post-content">
                                <div class="post-type-badge">
                                    @if (post.PostType == PostType.Vehicle)
                                    {
                                        <i class="bi bi-car-front"></i>
                                        <text> Vehicle</text>
                                    }
                                    else
                                    {
                                        <i class="bi bi-battery-charging"></i>
                                        <text> Battery</text>
                                    }
                                </div>

                                <h3 class="post-title">@post.Title</h3>

                                <p class="post-description">
                                    @(post.Description?.Length > 100 ? post.Description.Substring(0, 100) + "..." : post.Description)
                                </p>

                                @if (post.Vehicle != null)
                                {
                                    <div class="post-details-compact">
                                        <div class="detail-item">
                                            <i class="bi bi-speedometer2"></i>
                                            <span>@post.Vehicle.OdometerKm km</span>
                                        </div>
                                        <div class="detail-item">
                                            <i class="bi bi-calendar"></i>
                                            <span>@post.Vehicle.Year</span>
                                        </div>
                                    </div>
                                }
                                else if (post.Battery != null)
                                {
                                    <div class="post-details-compact">
                                        <div class="detail-item">
                                            <i class="bi bi-lightning-charge"></i>
                                            <span>@post.Battery.CapacityKwh kWh</span>
                                        </div>
                                        <div class="detail-item">
                                            <i class="bi bi-battery-half"></i>
                                            <span>@post.Battery.SohPercent% SOH</span>
                                        </div>
                                    </div>
                                }

                                <div class="post-footer">
                                    <div class="post-price">
                                        @if (post.Price.HasValue)
                                        {
                                            @post.Price.Value.ToString("N0")
                                            <text> VND</text>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Negotiable</span>
                                        }
                                    </div>
                                    <div class="post-location">
                                        <i class="bi bi-geo-alt"></i>
                                        @post.LocationAddress
                                    </div>
                                </div>

                                <div class="post-author">
                                    <i class="bi bi-person-circle"></i>
                                    <span>@post.AuthorName</span>
                                </div>

                                <div class="post-actions">
                                    <a asp-page="/PostPages/Details" asp-route-id="@post.Id"
                                       class="btn-action-clean">
                                        <i class="bi bi-eye"></i> View Details
                                    </a>

                                    @if (User.IsInRole("Admin"))
                                    {
                                        @if (post.Status != PostStatus.Removed)
                                        {
                                            <form method="post" asp-page-handler="Ban" asp-route-id="@post.Id" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn-action-clean btn-action-danger"
                                                        onclick="return confirm('Are you sure you want to ban this post? The owner will still see it as banned.');">
                                                    <i class="bi bi-slash-circle"></i> Ban
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <span class="badge-clean badge-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                                <i class="bi bi-lock-fill"></i> Already Banned
                                            </span>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            @if (Model.Posts.TotalPages > 1)
            {
                <div class="pagination-clean">
                    @if (Model.Posts.HasPrevious)
                    {
                        <a asp-page="/PostPages/Index"
                           asp-route-pageNumber="@(Model.Posts.CurrentPage - 1)"
                           asp-route-search="@Model.Search"
                           asp-route-postType="@Model.PostType"
                           asp-route-postVersion="@Model.PostVersion"
                           asp-route-postStatus="@Model.PostStatus"
                           asp-route-priceSort="@Model.PriceSort"
                           asp-route-minPrice="@Model.MinPrice"
                           asp-route-maxPrice="@Model.MaxPrice"
                           class="page-btn-clean">
                            <i class="bi bi-chevron-left"></i> Previous
                        </a>
                    }

                    <span class="page-info-clean">
                        Page @Model.Posts.CurrentPage of @Model.Posts.TotalPages
                    </span>

                    @if (Model.Posts.HasNext)
                    {
                        <a asp-page="/PostPages/Index"
                           asp-route-pageNumber="@(Model.Posts.CurrentPage + 1)"
                           asp-route-search="@Model.Search"
                           asp-route-postType="@Model.PostType"
                           asp-route-postVersion="@Model.PostVersion"
                           asp-route-postStatus="@Model.PostStatus"
                           asp-route-priceSort="@Model.PriceSort"
                           asp-route-minPrice="@Model.MinPrice"
                           asp-route-maxPrice="@Model.MaxPrice"
                           class="page-btn-clean">
                            Next <i class="bi bi-chevron-right"></i>
                        </a>
                    }
                </div>
            }
        }
        else
        {
            <div class="empty-state-clean">
                <i class="bi bi-inbox empty-icon-clean"></i>
                <h3 class="empty-title-clean">No Posts Found</h3>
                <p class="empty-description-clean">Try adjusting your filters or search criteria.</p>
            </div>
        }
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/profile.css" />
    <link rel="stylesheet" href="~/css/posts.css" />
}

@section Scripts {
    <script>
        // ✅ Select Price Range Function
        function selectPriceRange(min, max) {
            document.getElementById('minPriceInput').value = min === null ? '' : min;
            document.getElementById('maxPriceInput').value = max === null ? '' : max;
            document.getElementById('customMinPrice').value = '';
            document.getElementById('customMaxPrice').value = '';
            document.getElementById('filterForm').submit();
        }

        // ✅ Apply Custom Price Function
        function applyCustomPrice() {
            const customMin = document.getElementById('customMinPrice').value;
            const customMax = document.getElementById('customMaxPrice').value;

            if (customMin || customMax) {
                document.getElementById('minPriceInput').value = customMin;
                document.getElementById('maxPriceInput').value = customMax;
                document.getElementById('filterForm').submit();
            } else {
                alert('Please enter at least one price value (min or max)');
            }
        }

        // Auto-hide alerts
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);
    </script>
}