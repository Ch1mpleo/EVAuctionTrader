@page "{id:guid}"
@model EVAuctionTrader.Presentation.Pages.PostPages.DetailsModel
@{
    ViewData["Title"] = Model.Post?.Title ?? "Post Details";
    var isVip = Model.Post?.Version == EVAuctionTrader.BusinessObject.Enums.PostVersion.Vip;
}

@section Styles {
    <style>
        /* Dark Theme Variables */
        :root {
            --primary-color: #0070f3;
            --bg-dark: #0a0a0a;
            --bg-darker: #0f0f0f;
            --bg-card: #1a1a1a;
            --border-color: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --text-muted: #666666;
            --vip-gold: #FFD700;
        }

        /* Page Container */
        .detail-page-dark {
            background: var(--bg-dark);
            min-height: 100vh;
            padding: 2rem 0;
        }

        /* Breadcrumb */
        .breadcrumb-dark {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0 0 2rem 0;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

            .breadcrumb-dark a {
                color: var(--primary-color);
                text-decoration: none;
                transition: opacity 0.2s;
            }

                .breadcrumb-dark a:hover {
                    opacity: 0.8;
                }

        /* Grid Layout */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Gallery */
        .gallery-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            overflow: hidden;
        }

        .main-image {
            width: 100%;
            aspect-ratio: 16/10;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .thumbnail {
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

            .thumbnail.active {
                border-color: var(--primary-color);
            }

            .thumbnail img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        /* Info Sidebar */
        .info-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

            /* VIP Price Card - Yellow Border Only */
            .info-card.vip-card {
                border: 2px solid var(--vip-gold);
            }

        /* Price */
        .price-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

            /* VIP Price - Yellow Color */
            .price-display.vip-price {
                color: var(--vip-gold);
            }

        /* Title */
        .post-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        /* Badges */
        .badge-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .badge-vehicle {
            background: linear-gradient(135deg, #0070f3, #0059c1);
            color: white;
        }

        .badge-battery {
            background: linear-gradient(135deg, #00d4aa, #00ab8a);
            color: white;
        }

        .badge-banned {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            animation: pulse-red 2s infinite;
        }

        @@keyframes pulse-red {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Seller Info - Highlighted */
        .seller-section {
            background: linear-gradient(135deg, rgba(0,112,243,0.1) 0%, rgba(0,112,243,0.05) 100%);
            border: 2px solid rgba(0,112,243,0.3);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .seller-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Info Items */
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

            .info-item:last-child {
                border-bottom: none;
            }

        .info-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Actions */
        .action-btn {
            width: 100%;
            padding: 0.875rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }

        .btn-primary-action {
            background: var(--primary-color);
            color: white;
        }

            .btn-primary-action:hover {
                background: #0059c1;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,112,243,0.3);
            }

        .btn-secondary-action {
            background: var(--bg-darker);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

            .btn-secondary-action:hover {
                background: var(--border-color);
            }

        /* Content Section */
        .content-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .content-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .description-text {
            font-size: 0.9375rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        /* Specs Grid */
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .spec-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .spec-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .spec-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Comments Section */
        .comments-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .comments-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .comments-count {
            background: rgba(0,112,243,0.1);
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .comment-item {
            padding: 1rem;
            border-radius: 8px;
            background: var(--bg-darker);
            margin-bottom: 1rem;
        }

            .comment-item:last-child {
                margin-bottom: 0;
            }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9375rem;
        }

        .comment-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .comment-body {
            font-size: 0.9375rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .no-comments {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Alerts */
        .alert-banner {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-warning {
            border-color: #f59e0b;
            background: rgba(245,158,11,0.1);
        }

        .alert-danger {
            border-color: #dc2626;
            background: rgba(220,38,38,0.1);
        }

        /* Responsive */
        @@media (max-width: 991px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
}

<div class="detail-page-dark">
    <div class="container">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                @TempData["SuccessMessage"]
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                @TempData["ErrorMessage"]
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (Model.Post == null)
        {
            <div class="no-comments">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                <h2>Post Not Found</h2>
                <p>The post you're looking for doesn't exist or has been removed.</p>
            </div>
        }
        else
        {
            <!-- Breadcrumb -->
            <ol class="breadcrumb-dark">
                <li><a asp-page="/Home/LandingPage">Home</a></li>
                <li><i class="bi bi-chevron-right"></i></li>
                <li><a asp-page="/PostPages/Index">Posts</a></li>
                <li><i class="bi bi-chevron-right"></i></li>
                <li style="color: var(--text-secondary);">@Model.Post.Title</li>
            </ol>

            <!-- Ban Warning -->
            @if (Model.Post.Status == EVAuctionTrader.BusinessObject.Enums.PostStatus.Removed)
            {
                @if (User.IsInRole("Admin"))
                {
                    <div class="alert-banner alert-warning">
                        <i class="bi bi-shield-exclamation" style="font-size: 1.5rem; color: #f59e0b;"></i>
                        <div>
                            <strong>Admin Notice:</strong> This post has been banned and is hidden from public view.
                        </div>
                    </div>
                }
                else if (Model.IsAuthor)
                {
                    <div class="alert-banner alert-danger">
                        <i class="bi bi-exclamation-triangle-fill" style="font-size: 1.5rem; color: #dc2626;"></i>
                        <div>
                            <strong>Post Banned:</strong> Your post has been removed by an administrator. You cannot edit or republish this post.
                        </div>
                    </div>
                }
            }

            <div class="post-detail-wrapper">
                <div class="detail-grid">
                    <!-- Left Column - Gallery & Content -->
                    <div>
                        <!-- Gallery -->
                        <div class="gallery-section">
                            @if (Model.Post.PhotoUrls != null && Model.Post.PhotoUrls.Any())
                            {
                                <img src="@Model.Post.PhotoUrls.First()" alt="@Model.Post.Title" class="main-image" id="mainImage"
                                     onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'" />

                                @if (Model.Post.PhotoUrls.Count > 1)
                                {
                                    <div class="thumbnail-grid">
                                        @foreach (var (photo, index) in Model.Post.PhotoUrls.Select((p, i) => (p, i)))
                                        {
                                            <div class="thumbnail @(index == 0 ? "active" : "")" onclick="changeImage('@photo', this)">
                                                <img src="@photo" alt="Photo @(index + 1)"
                                                     onerror="this.src='https://via.placeholder.com/150?text=No+Image'" />
                                            </div>
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <img src="https://via.placeholder.com/800x600?text=No+Image" alt="No image" class="main-image" />
                            }
                        </div>

                        <!-- Description -->
                        <div class="content-section">
                            <h3 class="content-title">Description</h3>
                            <p class="description-text">@Model.Post.Description</p>
                        </div>

                        <!-- Specifications -->
                        @if (Model.Post.Vehicle != null)
                        {
                            <div class="content-section">
                                <h3 class="content-title">Vehicle Specifications</h3>
                                <div class="specs-grid">
                                    <div class="spec-item">
                                        <span class="spec-label">Brand</span>
                                        <span class="spec-value">@Model.Post.Vehicle.Brand</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Model</span>
                                        <span class="spec-value">@Model.Post.Vehicle.Model</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Year</span>
                                        <span class="spec-value">@Model.Post.Vehicle.Year</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Odometer</span>
                                        <span class="spec-value">@Model.Post.Vehicle.OdometerKm.ToString("N0") km</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Condition</span>
                                        <span class="spec-value">@Model.Post.Vehicle.ConditionGrade</span>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (Model.Post.Battery != null)
                        {
                            <div class="content-section">
                                <h3 class="content-title">Battery Specifications</h3>
                                <div class="specs-grid">
                                    <div class="spec-item">
                                        <span class="spec-label">Manufacturer</span>
                                        <span class="spec-value">@Model.Post.Battery.Manufacturer</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Chemistry</span>
                                        <span class="spec-value">@Model.Post.Battery.Chemistry</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Capacity</span>
                                        <span class="spec-value">@Model.Post.Battery.CapacityKwh kWh</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Cycle Count</span>
                                        <span class="spec-value">@Model.Post.Battery.CycleCount.ToString("N0")</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">State of Health</span>
                                        <span class="spec-value">@Model.Post.Battery.SohPercent%</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Voltage</span>
                                        <span class="spec-value">@Model.Post.Battery.VoltageV V</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Connector</span>
                                        <span class="spec-value">@Model.Post.Battery.ConnectorType</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Right Column - Info Sidebar -->
                    <div class="info-sidebar">
                        <!-- Price Card -->
                        <div class="info-card @(isVip ? "vip-card" : "")">
                            @if (Model.Post.Price.HasValue)
                            {
                                <div class="price-display @(isVip ? "vip-price" : "")">$@Model.Post.Price.Value.ToString("N0")</div>
                            }
                            else
                            {
                                <div class="price-display @(isVip ? "vip-price" : "")" style="@(isVip ? "" : "color: var(--text-muted);") font-size: 1.5rem;">Contact for price</div>
                            }

                            <h1 class="post-title">@Model.Post.Title</h1>

                            <div class="badge-row">
                                @if (isVip)
                                {
                                    <span class="badge" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white;">
                                        <i class="bi bi-star-fill"></i> VIP
                                    </span>
                                }
                                <span class="badge @(Model.Post.PostType == EVAuctionTrader.BusinessObject.Enums.PostType.Vehicle ? "badge-vehicle" : "badge-battery")">
                                    <i class="bi bi-@(Model.Post.PostType == EVAuctionTrader.BusinessObject.Enums.PostType.Vehicle ? "car-front-fill" : "battery-charging")"></i>
                                    @Model.Post.PostType
                                </span>
                                @if (Model.Post.Status == EVAuctionTrader.BusinessObject.Enums.PostStatus.Removed)
                                {
                                    <span class="badge badge-banned">
                                        <i class="bi bi-slash-circle"></i>
                                        Banned
                                    </span>
                                }
                            </div>
                        </div>

                        <!-- Seller Info - Highlighted -->
                        <div class="seller-section">
                            <div class="section-title">Seller Information</div>
                            <div class="seller-name">
                                <i class="bi bi-person-circle" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                @Model.Post.AuthorName
                            </div>
                        </div>

                        <!-- Details Card -->
                        <div class="info-card">
                            <div class="section-title">Details</div>
                            <div class="info-item">
                                <span class="info-label">Location</span>
                                <span class="info-value">@Model.Post.LocationAddress</span>
                            </div>
                            @if (Model.Post.PublishedAt.HasValue)
                            {
                                <div class="info-item">
                                    <span class="info-label">Published</span>
                                    <span class="info-value">@Model.Post.PublishedAt.Value.ToString("MMM dd, yyyy")</span>
                                </div>
                            }
                            @if (Model.Post.ExpiresAt.HasValue)
                            {
                                <div class="info-item">
                                    <span class="info-label">Expires</span>
                                    <span class="info-value">@Model.Post.ExpiresAt.Value.ToString("MMM dd, yyyy")</span>
                                </div>
                            }
                        </div>

                        <!-- Actions -->
                        @if (Model.IsAuthor)
                        {
                            @if (Model.Post.Status != EVAuctionTrader.BusinessObject.Enums.PostStatus.Removed)
                            {
                                <a asp-page="/PostPages/Update" asp-route-id="@Model.Post.Id" class="action-btn btn-primary-action">
                                    <i class="bi bi-pencil-square"></i> Edit Post
                                </a>
                            }
                        }
                        else if (User.Identity?.IsAuthenticated == true)
                        {
                            @if (Model.Post.Status != EVAuctionTrader.BusinessObject.Enums.PostStatus.Removed)
                            {
                                <button class="action-btn btn-primary-action" style="margin-bottom: 0.5rem;">
                                    <i class="bi bi-chat-dots"></i> Contact Seller
                                </button>
                                <button class="action-btn btn-secondary-action">
                                    <i class="bi bi-heart"></i> Save Post
                                </button>
                            }
                        }
                        else
                        {
                            @if (Model.Post.Status != EVAuctionTrader.BusinessObject.Enums.PostStatus.Removed)
                            {
                                <a asp-page="/Auth/Login" asp-route-returnUrl="@($"/PostPages/Details/{Model.Post.Id}")" class="action-btn btn-primary-action">
                                    <i class="bi bi-box-arrow-in-right"></i> Login to Contact
                                </a>
                            }
                        }

                        <!-- Comments Section - Moved to right column below actions -->
                        <div class="comments-section">
                            <div class="comments-header">
                                <h3 class="comments-title">
                                    <i class="bi bi-chat-left-text"></i>
                                    Comments
                                </h3>
                                <span class="comments-count">@Model.Post.Comments.Count</span>
                            </div>

                            @if (Model.Post.Comments.Any())
                            {
                                foreach (var comment in Model.Post.Comments)
                                {
                                    <div class="comment-item">
                                        <div class="comment-header">
                                            <span class="comment-author">
                                                <i class="bi bi-person-circle"></i>
                                                @comment.AuthorName
                                            </span>
                                            <span class="comment-date">@comment.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                                        </div>
                                        <p class="comment-body">@comment.Body</p>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="no-comments">
                                    <i class="bi bi-chat-left" style="font-size: 2rem; margin-bottom: 0.5rem; display: block; opacity: 0.5;"></i>
                                    <p>No comments yet. Be the first to comment!</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Image gallery functionality
        function changeImage(imageUrl, thumbnail) {
            const mainImage = document.getElementById('mainImage');
            mainImage.src = imageUrl;

            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            thumbnail.classList.add('active');
        }

        // Auto-hide alerts
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.3s';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);
    </script>
}