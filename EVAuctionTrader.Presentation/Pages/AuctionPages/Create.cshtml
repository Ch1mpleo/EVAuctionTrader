@page
@using EVAuctionTrader.BusinessObject.Enums
@model EVAuctionTrader.Presentation.Pages.AuctionPages.CreateModel
@{
    ViewData["Title"] = "Create Auction";
}

<div class="create-auction-page">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="bi bi-hammer"></i>
                        Create New Auction
                    </h1>
                    <p class="page-subtitle">Set up a live auction for vehicles or batteries</p>
                </div>

                <!-- Create Form Card -->
                <div class="create-form-card">
                    <form method="post" asp-page="/AuctionPages/Create">
                        @Html.AntiForgeryToken()

                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <strong>Please correct the following errors:</strong>
                                <ul class="mb-0 mt-2">
                                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                    {
                                        <li>@error.ErrorMessage</li>
                                    }
                                </ul>
                            </div>
                        }

                        <!-- Auction Type Section -->
                        <div class="form-section">
                            <h3 class="section-title">Auction Type</h3>

                            <div class="form-group">
                                <label asp-for="AuctionRequest.AuctionType" class="form-label">Select Type *</label>
                                <select asp-for="AuctionRequest.AuctionType" class="form-control" id="auctionType" required>
                                    <option value="">Choose auction type...</option>
                                    <option value="@((int)AuctionType.Vehicle)">Vehicle</option>
                                    <option value="@((int)AuctionType.Battery)">Battery</option>
                                </select>
                            </div>
                        </div>

                        <!-- Vehicle Fields (shown when Vehicle selected) -->
                        <div class="form-section" id="vehicleSection" style="display: none;">
                            <h3 class="section-title">Vehicle Information</h3>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Vehicle.Brand" class="form-label">Brand *</label>
                                        <input asp-for="AuctionRequest.Vehicle.Brand" class="form-control" placeholder="Tesla, BMW, VinFast..." />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Vehicle.Model" class="form-label">Model *</label>
                                        <input asp-for="AuctionRequest.Vehicle.Model" class="form-control" placeholder="Model 3, i3, VF8..." />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Vehicle.Year" class="form-label">Year *</label>
                                        <input asp-for="AuctionRequest.Vehicle.Year" class="form-control" type="number" min="2000" max="2025" placeholder="2023" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Vehicle.OdometerKm" class="form-label">Odometer (km) *</label>
                                        <input asp-for="AuctionRequest.Vehicle.OdometerKm" class="form-control" type="number" min="0" placeholder="15000" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Vehicle.ConditionGrade" class="form-label">Condition *</label>
                                        <select asp-for="AuctionRequest.Vehicle.ConditionGrade" class="form-control">
                                            <option value="">Select...</option>
                                            <option value="Excellent">Excellent</option>
                                            <option value="Very Good">Very Good</option>
                                            <option value="Good">Good</option>
                                            <option value="Fair">Fair</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Battery Fields (shown when Battery selected) -->
                        <div class="form-section" id="batterySection" style="display: none;">
                            <h3 class="section-title">Battery Information</h3>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Battery.Manufacturer" class="form-label">Manufacturer *</label>
                                        <input asp-for="AuctionRequest.Battery.Manufacturer" class="form-control" placeholder="CATL, LG Chem, BYD..." />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Battery.Chemistry" class="form-label">Chemistry *</label>
                                        <input asp-for="AuctionRequest.Battery.Chemistry" class="form-control" placeholder="Lithium-ion NMC, LFP..." />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Battery.CapacityKwh" class="form-label">Capacity (kWh) *</label>
                                        <input asp-for="AuctionRequest.Battery.CapacityKwh" class="form-control" type="number" step="0.1" min="0" placeholder="60.0" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Battery.SohPercent" class="form-label">SOH (%) *</label>
                                        <input asp-for="AuctionRequest.Battery.SohPercent" class="form-control" type="number" step="0.1" min="0" max="100" placeholder="85.0" />
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Battery.CycleCount" class="form-label">Cycle Count *</label>
                                        <input asp-for="AuctionRequest.Battery.CycleCount" class="form-control" type="number" min="0" placeholder="800" />
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Battery.VoltageV" class="form-label">Voltage (V) *</label>
                                        <input asp-for="AuctionRequest.Battery.VoltageV" class="form-control" type="number" step="0.1" min="0" placeholder="400.0" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.Battery.ConnectorType" class="form-label">Connector Type *</label>
                                        <select asp-for="AuctionRequest.Battery.ConnectorType" class="form-control">
                                            <option value="">Select...</option>
                                            <option value="CCS2">CCS2</option>
                                            <option value="Type 2">Type 2</option>
                                            <option value="CHAdeMO">CHAdeMO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Basic Information Section -->
                        <div class="form-section">
                            <h3 class="section-title">Auction Details</h3>

                            <div class="form-group">
                                <label asp-for="AuctionRequest.Title" class="form-label">Title *</label>
                                <input asp-for="AuctionRequest.Title" class="form-control" placeholder="2022 Tesla Model 3 - Low Mileage" required />
                            </div>

                            <div class="form-group">
                                <label asp-for="AuctionRequest.Description" class="form-label">Description *</label>
                                <textarea asp-for="AuctionRequest.Description" class="form-control" rows="4" 
                                          placeholder="Provide detailed information about the item..." required></textarea>
                            </div>

                            <div class="form-group">
                                <label asp-for="AuctionRequest.PhotoUrl" class="form-label">Photo URL</label>
                                <input asp-for="AuctionRequest.PhotoUrl" class="form-control" type="url" placeholder="https://example.com/image.jpg" />
                                <small class="form-text">Enter a direct link to an image</small>
                            </div>
                        </div>

                        <!-- Pricing Section -->
                        <div class="form-section">
                            <h3 class="section-title">Pricing & Bidding</h3>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.StartPrice" class="form-label">Starting Price ($) *</label>
                                        <input asp-for="AuctionRequest.StartPrice" class="form-control" type="number" step="100" min="1" 
                                               placeholder="10000" required />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.MinIncrement" class="form-label">Min Bid Increment ($) *</label>
                                        <input asp-for="AuctionRequest.MinIncrement" class="form-control" type="number" step="10" min="1" 
                                               placeholder="100" required />
                                        <small class="form-text">Each bid must increase by at least this amount</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label asp-for="AuctionRequest.DepositRate" class="form-label">Deposit Rate *</label>
                                <div class="input-group">
                                    <input asp-for="AuctionRequest.DepositRate" class="form-control" type="number" step="0.01" min="0.01" max="1" 
                                           value="0.20" id="depositRateInput" required />
                                    <span class="input-group-text" id="depositRatePercent">20%</span>
                                </div>
                                <small class="form-text">Percentage of bid amount to hold as deposit (0.01 to 1.00)</small>
                            </div>
                        </div>

                        <!-- Schedule Section -->
                        <div class="form-section">
                            <h3 class="section-title">Schedule</h3>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.StartTime" class="form-label">Start Date & Time *</label>
                                        <input asp-for="AuctionRequest.StartTime" class="form-control" type="datetime-local" required />
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="AuctionRequest.EndTime" class="form-label">End Date & Time *</label>
                                        <input asp-for="AuctionRequest.EndTime" class="form-control" type="datetime-local" required />
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-lightbulb-fill"></i>
                                The auction will automatically start at the scheduled time
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="form-actions">
                            <button type="submit" class="btn-submit">
                                <i class="bi bi-check-circle-fill"></i>
                                Create Auction
                            </button>
                            <a asp-page="/AuctionPages/Index" class="btn-cancel">
                                <i class="bi bi-x-circle"></i>
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/auction-create.css" />
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Show/hide vehicle/battery sections based on auction type
        document.getElementById('auctionType').addEventListener('change', function() {
            const vehicleSection = document.getElementById('vehicleSection');
            const batterySection = document.getElementById('batterySection');
            
            if (this.value == '@((int)AuctionType.Vehicle)') {
                vehicleSection.style.display = 'block';
                batterySection.style.display = 'none';
                
                // Set required for vehicle fields
                vehicleSection.querySelectorAll('input, select').forEach(el => el.required = true);
                batterySection.querySelectorAll('input, select').forEach(el => el.required = false);
            } else if (this.value == '@((int)AuctionType.Battery)') {
                vehicleSection.style.display = 'none';
                batterySection.style.display = 'block';
                
                // Set required for battery fields
                vehicleSection.querySelectorAll('input, select').forEach(el => el.required = false);
                batterySection.querySelectorAll('input, select').forEach(el => el.required = true);
            } else {
                vehicleSection.style.display = 'none';
                batterySection.style.display = 'none';
                
                vehicleSection.querySelectorAll('input, select').forEach(el => el.required = false);
                batterySection.querySelectorAll('input, select').forEach(el => el.required = false);
            }
        });

        // Update deposit rate percentage display
        document.getElementById('depositRateInput').addEventListener('input', function() {
            const percentage = (parseFloat(this.value) * 100).toFixed(0);
            document.getElementById('depositRatePercent').textContent = percentage + '%';
        });

        // Set minimum datetime to now
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const minDateTime = now.toISOString().slice(0, 16);
        
        const startTimeInput = document.querySelector('input[name="AuctionRequest.StartTime"]');
        const endTimeInput = document.querySelector('input[name="AuctionRequest.EndTime"]');
        
        startTimeInput.min = minDateTime;
        
        // Set end time minimum based on start time
        startTimeInput.addEventListener('change', function() {
            const startTime = new Date(this.value);
            startTime.setHours(startTime.getHours() + 1);
            startTime.setMinutes(startTime.getMinutes() - startTime.getTimezoneOffset());
            endTimeInput.min = startTime.toISOString().slice(0, 16);
            
            if (endTimeInput.value && new Date(endTimeInput.value) <= new Date(this.value)) {
                endTimeInput.value = startTime.toISOString().slice(0, 16);
            }
        });

        // Trigger on page load
        if (startTimeInput.value) {
            startTimeInput.dispatchEvent(new Event('change'));
        }

        const auctionTypeSelect = document.getElementById('auctionType');
        if (auctionTypeSelect.value) {
            auctionTypeSelect.dispatchEvent(new Event('change'));
        }
    </script>
}
